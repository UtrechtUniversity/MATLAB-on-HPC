# SSH

SSH stands for secure shell and is a protocol that makes it possible to remotely login to other computers (such as HPC clusters or virtual machines).
To setup this connection, you need a 'terminal' application. We recommend [MobaXterm](https://mobaxterm.mobatek.net/download.html) to do this.

To start a session in MobaXterm: click the Session tab, and fill in the Basic SSH settings: the host that you want to connect to, the username and the port. Potentially some additional settings need to be filled in to smooth the login process at HPC systems: e.g. to jump from a gateway node to a submit node directly upon login, or to attach a key. For these type of settings, follow the login instructions from the HPC system ( [UBC](https://wiki.bioinformatics.umcutrecht.nl/bin/view/HPC/HowToS#How_to_log_in_from_outside_the_U)  or [LISA](https://userinfo.surfsara.nl/systems/lisa/getting-started) ).

## SSH keys
Some SSH connections are set up using SSH ['key pairs'](https://winscp.net/eng/docs/ssh_keys). These can be generated with MobaXterm under tools > MobaKeyGen. When generated by moving your mouse: a public key is displayed in the key generator window. Fill in a passphrase that will be required when making the SSH connection. The public key that is displayed should be copy and pasted in an email to the system administrator. The private key should be saved. To use this private key to make the connection, check the 'Use private key' and navigate to the private key file under Advanced SSH settings when setting up or editing an SSH session.

## Establish SSH connection between Docker container and UBC cluster
Note that (when SSH keys are required for login) each device (i.e. local working station, docker container) needs to exchange keys to make a connection. To make a direct connection from a docker container to the UBC cluster a new set of keys should be generated within the Docker container

In an ssh session to Docker container, go to the root folder:
```
cd ~
mkdir .ssh
cd .ssh
```
Generate key pairs using the following command:
```
ssh-keygen -t rsa -C hpc -f ~/.ssh/id_rsa_hpc 
```
give a new passphrase (twice).

Open the id_rsa_hpc.pub file
```
vim id_rsa_hpc.pub
```
and copy and paste the contents in an email to the system administrator and exit the file.

## Config file

Now create a config file
```
vim config
```
Paste the following text:

```
# file ~/.ssh/config 
# example HPC config file 
# 20180111 UMC/HPC 

# usage : ssh hpcgw 
Host hpcgw 
  HostName hpcgw.op.umcutrecht.nl
  IdentityFile ~/.ssh/id_rsa_hpc 
  User <username>

# usage : ssh gw2hpcs03
Host gw2hpcs03
  HostName hpcs03.op.umcutrecht.nl
  User <username>
  ProxyCommand ssh -i ~/.ssh/id_rsa_hpc -l <username> hpcgw.op.umcutrecht.nl nc %h %p 2>/dev/null

# usage : ssh gw2hpcs04
Host gw2hpcs04
  HostName hpcs04.op.umcutrecht.nl
  User <username>
  ProxyCommand ssh -i ~/.ssh/id_rsa_hpc -l <username> hpcgw.op.umcutrecht.nl nc %h %p 2>/dev/null
```
Now it is possible to setup an ssh, sftp or scp session between the Docker container and the cluster directly.
Contact UBC system administrators when you need help with this.

# SCP

There are two ways to transfer files between the HPC cluster and your PC: via the scp command using the command line or manually using an interactive SFTP browser.
Manually works only between the cluster and your PC, and between your docker container and your PC. To transfer between docker container and HPC cluster use the scp command (or alternatively copy manually to your PC first)

**Manual copy** When you are in an active SSH session in MobaXterm, there may already be a side-bar visible in the left of your window. If this subwindow not visible, click View > Show/Hide Side-bar.  

On the left of the Sidebar, click Sftp

At the bottom of the Sidebar, check the ‘Follow terminal folder’ box.

To transfer files to your local PC, select files and click 'download selected files' at the top of the subwindow.

To transfer files from your local machine, click the 'upload to current folder' button.


**Transfer using command line**

When you are in an SSH session to your Docker container, you can use scp to copy files directly to an HPC cluster. The syntax is

```
scp <file> <destination>
```
For example, to copy myfile.txt from the current directory on your local machine to the directory destinationdir on the cluster:

```
scp myfile.txt <remote adress>:destinationdir

scp myfile.txt gw2hpcs03:/home/<usergroup> / <username>
```










